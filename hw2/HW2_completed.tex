\documentclass[11pt]{article}

% Load packages
\usepackage{minted}
\usepackage{amsmath, amsfonts, mathtools} % for math
\usepackage{graphicx, float} % for figures
\usepackage[margin=1in]{geometry} % to set margins
\usepackage{tcolorbox} % to create nice boxes
\tcbuselibrary{skins,breakable} % extra libraries for the nice boxes
\usepackage{appendix}
\allowdisplaybreaks % allow aligned equations to display across pages

% Sets the default font to sans serif
% \renewcommand\familydefault{\sfdefault}

% Define a custom box for the solutions. Don't change this!
\newtcolorbox[]{solution}
    {colframe=red!20, 
        colback=white, 
        sharp corners,
        title=Solution,
        enhanced,
        breakable,
        coltitle=black,
        fonttitle=\bfseries,
        attach boxed title to top left={yshift*=-\tcboxedtitleheight/2, xshift=3mm},
        boxed title style={sharp corners, colback=red!20}
        }


\usepackage{listings}
\usepackage{enumerate}
\usepackage{empheq}
\usepackage{caption}

\usepackage[font=footnotesize]{caption}

\usepackage{boondox-calo}

\newcommand{\lr}[1]{\left(#1\right)}

\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan
}

% MSE Set graphics path
\graphicspath{{figs/}}

% MSE Terminal environment for screenshots
\lstdefinestyle{Terminal}
{
    basicstyle=\fontsize{9}{11}\color{black}\ttfamily
}

% MSE Code snippets
\lstdefinestyle{CodeSnippet}
{
    basicstyle=\fontsize{10}{12}\color{black}\ttfamily
}
% MSE Macros
\newcommand{\tty}[1]{\texttt{#1}}

% Write the document
\begin{document}

    \title{Extreme Computing: Homework 2}
    \author{Michael S. Emanuel, Jonathan Guillotte-Blouin, Yue Sun}
    \date{April 15, 2019}
    \maketitle

  \section{Problem 1:  Channel Flow with a central narrowing}
    Simulating channel flow in 2D with a narrowing is the target.

The type of flow in absence of the narrowing is the well-known Hagen-Poiseuille flow 
(and by the way, Poiseuille was a physicist and physiologist who studied blood flows 
in a systematic way).

Let's write the corresponding grid for a straight channel aligned along, say, the x axis. 

When constructing the grid and using it in the LBM context 
you should apply what you have learned about grid management. 

Let's recall that in absence of open boundaries (inlet or outlet), each fluid node should always 
be surrounded by other fluid or wall nodes to preserve mass and momentum locally (no leakage rule).

The solution should employ two different options:

    \begin{enumerate}
      \item A periodic channel (aligned with the x direction): start from a quiescent fluid and
      apply a body acceleration uniformly through the fluid until you match the Reynolds number at steady state.
      \item A non-periodic channel with inlet and outlet faces and by applying a uniform velocity 
      at inlet and outlet with plug flow profiles.
    \end{enumerate}

    Use no-slip boundary conditions at the walls and a Reynolds number of $10^{-2}$ computed from fluid velocity 
    imposed at $x=0$ (the inlet region for non-period channel) and characterstic length being $H$.

    \begin{figure}[h!]
      \centering{}\includegraphics[scale=1.0]{narrowing.png}
      \caption{The geometry for the channel with central narrowing.}
      \label{fig:narrowing}
    \end{figure}
    
    % Solution    
    \begin{solution}
        \input{1_codereview.tex}
    \end{solution}

    
    \textbf{For a fixed set of values for the geometry 
    as in Fig. \ref{fig:narrowing}, (suggested values $L=200$, $H=60$, $l=50$, $w=30$), 
    calculate the following quantities:}
    \begin{enumerate}
      \item The pressure field
      \item The velocity field 
      \item The volume flow rate 
      \item The average and maximum velocities in the channel
    \end{enumerate}
    % Solution    
    \begin{solution}
        \input{HW2_solution/2_plot.tex}
    \end{solution}

    Repeat the simulation by varying the width of the narrowing $w$.
    
    \textbf{Plot:}
    Show how the flow rate changes by varying $w$ in the range $0<w<50$
    
    Compare the pressure at the narrowing with the simple Bernoulli estimate for inviscid flows, stating that
    $$
    \frac{1}{2} \rho u_o^2 + p_o = \frac{1}{2} \rho u_i^2 + p_i
    $$
    where $u_o$ and $p_o$ are cross-sectional averages of velocity and pressure at $x=0$ for a periodic system 
    or at the inlet otherwise, and $u_i$ and $p_i$ are the same quantities at the center of the narrowing.
    
    % Solution    
    \begin{solution}
        \input{HW2_solution/3_plot.tex}
    \end{solution}
    
    \textbf{Plot:}
    Plot the obtained pressure vs the Bernoulli estimate by varying the LBM kinematic viscosity in the range 0.05 : 0.1667.
    % Solution    
    \begin{solution}
        \input{HW2_solution/4_bernoulli.tex}
    \end{solution}
    


%%% PROBLEM 2 %%%
\newpage
  \section{Problem 2:  Basic CUDA and GPUs}
    \textit{This problem was submitted by Dan Willen \texttt{daniel.p.willen@gmail.com}}

    Consider the equation
    \begin{equation}\label{eq:heat}
      \frac{\partial u}{\partial t} = D \nabla^2 u,
    \end{equation}
    on the domain \(0 \leq x,y \leq \pi\), with \(u = u(x,y,t)\), \(D\) the diffusive constant, and \(\nabla^2\) the Laplace operator.
    The boundary conditions are of the homogeneous Dirichlet type:
    \begin{equation}
      u(x = 0, y) = u(x = \pi, y) = u(x, y = 0) = u(x, y = \pi) = 0,
    \end{equation}
    and the initial condition is
    \begin{equation}
      u(x,y, t = 0) = \sin(x) \sin(y).
    \end{equation}
    The solution to this equation is
    \begin{equation}
      u(x,y,t) = \sin(x) \sin(y) \exp{(-2Dt)}
    \end{equation}
    
    Using a second-order central difference in space and first order forward difference in time, the discretization of \eqref{eq:heat} is
    \begin{equation}
      u_{i,j}^{\left(n+1\right)} = u_{i,j}^{\left(n\right)} + \frac{D \Delta t}{\Delta x^2} 
        \left[u_{i+1, j}^{\left(n\right)} +
              u_{i-1, j}^{\left(n\right)} +
              u_{i, j+1}^{\left(n\right)} +
              u_{i, j-1}^{\left(n\right)} -
              4u_{i, j}^{\left(n\right)} \right],
    \end{equation}
    where \(u_{i,j}^{\left(n\right)}\) is the value of \(u\) at the \(n^{th}\) time step at grid point \((i,j)\), \(\Delta t = \Delta x^2 / 4D\) is the time step size, and \(\Delta x\) is the grid spacing in the \(x\) and \(y\) directions.
    
    \vspace{5mm}
    
    \begin{enumerate}
      \item Using Cuda, solve the discretized equations up to a time \(t = \pi^2/D\) using the Jacobi method.
        A skeleton code is provided to assist you, with comments in the locations you should make changes.
        \begin{enumerate}[Step I --]
          \item Declare, allocate, and initialize memory for the field variable \texttt{u} on the CPU.
            You should allocate enough memory for the grid, which has size \(nx \times ny\) and initialize \texttt{u} to the initial condition.
            Make sure you free the memory at the end of the program.
          \item Declare and allocate the GPU memory for \texttt{\_u}, \texttt{\_u\_new}\, and \texttt{\_error}.
            Copy the CPU memory to the GPU; the other two arrays have been initialized to zero for you.
            Make sure you free the memory at the end of the program.
          \item Set up the kernel execution configuration for the GPU kernel based on the input domain size and the maximum threads per dimension,
            which is set at the top of the file as a \texttt{\#define}.
            You will need to determine the number of threads per block and the number of blocks in each direction, as well as set up the \texttt{dim3} variables.
          \item Write a GPU kernel that advances to the next timestep using the Jacobi method.
            This should be done in parallel, not in serial.
          \item Write a GPU kernel that calculates the error between the numerical and analytic solutions at each point.
            Be careful to compare solutions at the correct timestep -- \texttt{\_u\_new} is at \(t = (n+1) \Delta t\) and \texttt{\_u} is at \(t = n \Delta t\).
            Using this result, a parallel reduction using the Thrust parallel algorithms library has been provided to calculate the total error in order to find the average percent error at each grid point.
          \item At the end of the loop, copy the data back to the CPU.
        \end{enumerate}
    \end{enumerate}
    
    Your program should take as an input the number of grid cells on one side of the domain.
    This has been set up for you such that the program can be run from the command line like: 
    \vspace{3mm}\\ \texttt{./jacobi\_solver.cu n} \vspace{3mm}\\
    where \(nx = ny = \) \texttt{n} is the size of one side of the square domain.
    The program should output the percent difference between your result and the analytic solution, averaged over all of the grid nodes:
    \begin{equation}
      \epsilon = \frac{1}{n_x n_y} \sum_{i=1}^{n_x} \sum_{j=1}^{n_y} \frac{u_{i,j}^{\left(n\right)} -
U_{i,j}^{\left(n\right)}}{U_{i,j}^{\left(n\right)}},
    \end{equation}
    where \(U\) is the analytic solution.
    
    % Solution    
    \begin{solution}
        \input{HW2_solution/cuda_1.tex}
    \end{solution}

    If you have time, discuss the following:
    \begin{itemize}
      \item How does the error change as you increase the resolution? Does this behavior make sense?
      \begin{solution}
        The error scales according to $\Delta X^2$.  
        We ran a linear regression of $\log(\epsilon) \sim \log(n)$
        and the estimated slope was -1.997, very close to theoretical value of -2.0 we would have expected.
        Here is the plot:
        \begin{figure}[H]
            \centering
            \includegraphics[width=0.85\textwidth]{jacobi_error.png}
            \caption{Jacobi error vs. grid size.}
        \end{figure}
      \end{solution}


      \item How does the runtime scale with the resolution? You can get a rough estimate by using the bash command \texttt{time} when executing your program, like:
    \vspace{3mm}\\ \texttt{./jacobi\_solver.cu n} \vspace{3mm}\\ and using the result for \texttt{real}. \\
    \begin{solution}
    Intuitively we would expect that the run-time should scale quadratically with the grid size.
    This result is borne out over the range of $n$ tested above.  
    The numerical estimate of the slope of $\log(t)$ vs. $\log(n)$ was 1.922.
    Here is the plot:
    \begin{figure}[H]
        \centering
        \includegraphics[width=0.85\textwidth]{jacobi_time.png}
        \caption{Jacobi runtime vs. grid size.}
    \end{figure}
    \end{solution}


      \item How does the runtime change as you change the kernel execution configuration?
        e.g., play around the \texttt{MAX\_THREADS\_DIM} parameter as well as different schemes for setting up the thread blocks.
        \begin{solution}
            We tried the following choices for the number of threads: 8, 16, 32, 64.
            64 threads didn't run; the program terminated immediately.
            Run-time with 8, 16, and 32 was 39.940, 44,363, and 36.698 seconds, respectively.
            This didn't make a huge amount of sense, because it wasn't even monotonic.
            A second trial with n=16 took 40.542 seconds.
            If we had to guess, there is probably an advantage to using as many threads as possible (probably 32 on the Titan-V card), but this advantage likely matters more for larger calculations than this one for n=256.
        \end{solution}

      \item Use shared memory in the Jacobi kernel
    \end{itemize}
    
\appendix
\section{Validity of the LBM solver}
First we verify the periodic version. We follow the same setup of a simple Poiseuille flow in Sauro Succi's \textit{The Lattice Boltzmann Equation for Fluid Dynamics and Beyond} in Section 7.3 (page 103), with no channel narrowing or obstacle: $L=128, H=32, \nu=0.1, u_0=0.1$. Note that our solver set \textit{Re} to fix $u_0$, set $\tau$ to fix $\nu$, and set the characteristic length $D=H$. (This $u_0$ is not to set the initial velocity as $u_0$, but to fix \textit{Re}.) In order to get the steady state velocity to be equal to $u_0=0.1$, we fix the Reynolds number \textit{Re}, the relaxation time $\tau$ and the forcing term by
\begin{align}
    \tau &= \frac{6\nu +1}{2}=0.8 \\
    \textit{Re} &= \frac{u_0 L}{\nu}=32 \\
    force &= \frac{8\mu u_{max}}{H^2} = \frac{8\rho \nu u_{max}}{H^2} = \frac{1}{12800}
\end{align}
\noindent We set the initial density, velocity in both directions to be 1, 0, 0, run the simulation 10000 iterations and output every 100 frames. We plot the velocity fields at the center of the channel ($x=\frac{L}{2}$) in both x and y direction with respect to simulation time.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{HW2_solution/figs/app_pbc_01.png}
    \caption{$U_x$ profile of Poiseuille flow in a periodic channel.}
    \includegraphics[width=0.7\textwidth]{HW2_solution/figs/app_pbc_01y.png}
    \caption{$U_y$ profile of Poiseuille flow in a periodic channel.}
\end{figure}
\noindent The velocity in the x direction $u_x$ starts from zero, gradually develops into a parabolic shape in the vertical direction, reaches the steady state velocity $u_0=0.1$ and stays at the speed. The velocity in the y direction $u_y$ experiences some oscillation, but remains at almost zero. Next We plot the average density at each output frame to verify conservation of mass.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{HW2_solution/figs/app_pbc_01rho.png}
    \caption{Time evolution of average density.}
\end{figure}
\noindent The horizontal line verifies matches the expectation that density of the Poiseuille flow in a periodic channel is conserved, $u_x$ will have a parabolic shape and $u_y$ is zero. Last we compare the simulation result of $u_x$ with analytical solution $$u(y)=\frac{force}{2\mu}y(H-y)$$
\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{HW2_solution/figs/app_pbc_com.png}
    \caption{Simulation result vs. analytical solution of $u_x$.}
\end{figure}
\noindent The simulation $u_x$ is chosen to be of the last frame, where the Poiseuille flow has reached steady state. And we can see the simulation result matches exactly with the analytical solution.

\end{document}


    